# üõ°Ô∏è This file is MIT licensed. See LICENSE in the repository.
# -------------------------------------------------------------------------------------
# üõ°Ô∏è NOTE: For most repositories, you should strongly consider using GitHub's official code security tools
# (such as CodeQL and Dependabot), which are free for public repositories.
# See https://github.com/features/security for details.
#
# ‚ö†Ô∏è DISCLAIMER:
# This workflow is a community-developed tool and is not affiliated with, endorsed by, or officially supported by GitHub or the CodeQL team.
# It is provided as-is for public use.
# This workflow should not be considered an official GitHub or CodeQL product.
# Use at your own discretion.
#
# üöÄ Workflow:
# - Runs CodeQL analysis on a repository
# - Scans for security and quality issues
# - Automatically creates a GitHub issue for EACH new finding
# - Attaches the specific SARIF finding data to each issue
# - Is reusable and can be called from other workflows
#
# üß© How it works:
# - Runs CodeQL analysis for the specified language.
# - Generates a SARIF report with security and quality findings.
# - Processes the SARIF file and for each result:
#   - Deduplicates findings using a hash of its rule, location, and message.
#   - Creates a GitHub issue for each new finding, labeled 'codeql-finding'.
#   - Attaches the specific SARIF result for that finding in a collapsible section.
#   - Skips open issues and respects closed ones (does not reopen).
# - Can be called from other workflows using 'workflow_call'.
# -------------------------------------------------------------------------------------
# üß™ Usage Example
#
# To use this action in your workflow, add the following to your workflow YAML:
#
# name: 'CodeQL'
#
# permissions:
#   security-events: write
#   actions: read
#   contents: read
#   issues: write
#
# on:
#   push:
#     branches:
#       - main
#   pull_request:
#     branches:
#       - main
#   schedule:
#     - cron: '30 1 * * 0'
#
# jobs:
#   analyze:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4
#
#       - name: Run CodeQL Analysis and Create Issues
#         uses: pixpilot/github/actions/codeql-issue-maker@main
#         with:
#           token: ${{ secrets.GITHUB_TOKEN }}
#           # language: 'javascript'
#           # exclude: 'tests/**,**/__tests__/**,**/*.test.ts,*.spec.ts,**/*.min.js,dist/**,build/**,coverage/**,*.md,*.txt,*.pdf,*.png,*.jpg,*.ico'
# -------------------------------------------------------------------------------------

name: CodeQL Issue Maker
description: 'Runs CodeQL analysis, filters files, and creates GitHub issues for findings.'

inputs:
  language:
    description: The programming language to scan
    required: true
    default: javascript
  qls-profile:
    description: 'The CodeQL QLS profile to use (e.g., security-and-quality, security-extended)'
    required: false
    default: security-and-quality
  include:
    description: Glob pattern(s) to include files (comma-separated)
    required: false
  exclude:
    description: Glob pattern(s) to exclude files (comma-separated)
    required: false
  token:
    description: GITHUB_TOKEN for creating issues
    required: true

runs:
  using: node20
  main: dist/index.js
